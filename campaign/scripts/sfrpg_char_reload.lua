--
-- Please see the LICENSE.md file included with this distribution for attribution and copyright information.
--

local function getContainedItems(nodeContainer)
	local containerName = ItemManager.getSortName(nodeContainer)
	local containedItems = {}
	if containerName ~= '' then
		for _, nodeItem in ipairs(DB.getChildList(nodeContainer, '..')) do
			if DB.getValue(nodeItem, 'carried', 0) ~= 0 then
				local itemContainerName = StringManager.trim(DB.getValue(nodeItem, 'location', '')):lower()
				if itemContainerName == containerName then table.insert(containedItems, nodeItem) end
			end
		end
	end
	return containedItems
end

local function loadCartridges(weaponActionNode, newAmmoNode, loadedAmmoNode)
	local weaponInventoryNode = AmmunitionManager.getShortcutNode(weaponActionNode, 'shortcut')
	local maxAmmo, _ = AmmunitionManager.parseWeaponCapacity(DB.getValue(weaponInventoryNode, 'capacity', ''))
	local currentAmmoCount = 0
	if loadedAmmoNode then
		currentAmmoCount = DB.getValue(loadedAmmoNode, 'count', 0)
	else
		loadedAmmoNode = DB.createChild(DB.getParent(newAmmoNode))
		loadedAmmoNode = DB.copyNode(newAmmoNode, loadedAmmoNode)
		DB.setValue(loadedAmmoNode, 'location', 'string', ItemManager.getDisplayName(weaponInventoryNode, true))
	end
	local newAmmoCount = DB.getValue(newAmmoNode, 'count', 0)
	local ammoNeeded = maxAmmo - currentAmmoCount
	if ammoNeeded > newAmmoCount then
		ammoNeeded = newAmmoCount
	end
	DB.setValue(loadedAmmoNode, 'count', 'number', currentAmmoCount + ammoNeeded)
	DB.setValue(newAmmoNode, 'count', 'number', newAmmoCount - ammoNeeded)
	return loadedAmmoNode
end

local function isSameAmmo(ammo1, ammo2) return ammo1 and ammo2 and ItemManager.compareFields(ammo1, ammo2, true) end

local function unloadAmmunition(loadedAmmoNode)
	if loadedAmmoNode then DB.setValue(loadedAmmoNode, 'location', 'string', '') end
end

local function moveInventoryAmmunition(weaponActionNode, newAmmoNode)
	local weaponInventoryNode = AmmunitionManager.getShortcutNode(weaponActionNode, 'shortcut')
	local loadedAmmoNode = getContainedItems(weaponInventoryNode)[1]
	if not newAmmoNode then -- no new ammo, unload old
		unloadAmmunition(loadedAmmoNode)
		return newAmmoNode
	end

	local _, ammoType = AmmunitionManager.parseWeaponCapacity(DB.getValue(weaponInventoryNode, 'capacity', ''))
	if ammoType == 'drawn' then
		return newAmmoNode
	end

	if ammoType == 'charges' then
		if loadedAmmoNode then DB.setValue(loadedAmmoNode, 'location', 'string', '') end
		DB.setValue(newAmmoNode, 'location', 'string', ItemManager.getDisplayName(weaponInventoryNode, true))
		return newAmmoNode
	end
	if isSameAmmo(loadedAmmoNode, newAmmoNode) then
		return loadCartridges(weaponActionNode, newAmmoNode, loadedAmmoNode)
	else
		unloadAmmunition(loadedAmmoNode)
		return loadCartridges(weaponActionNode, newAmmoNode)
	end
end

--	luacheck: globals loadAmmo
function loadAmmo(ammoItem)
	local nodeWeaponAction = getDatabaseNode()
	if ammoItem then
		local nodeAmmoItem = ammoItem.getDatabaseNode()
		local nodeAmmo = moveInventoryAmmunition(nodeWeaponAction, nodeAmmoItem)
		DB.setValue(nodeWeaponAction, 'ammopicker', 'string', ItemManager.getDisplayName(nodeAmmoItem, true))
		DB.setValue(nodeWeaponAction, 'ammoshortcut', 'windowreference', 'item', '....inventorylist.' .. DB.getName(nodeAmmo))
		local rActor = CharManager.getWeaponAttackRollStructures(nodeWeaponAction)
		local messagedata = {
			text = Interface.getString('char_message_reloadammo'),
			sender = rActor.sName,
			font = 'emotefont',
		}
		Comm.deliverChatMessage(messagedata)
	else
		moveInventoryAmmunition(nodeWeaponAction)
		DB.setValue(nodeWeaponAction, 'ammopicker', 'string', '')
		DB.setValue(nodeWeaponAction, 'ammoshortcut', 'windowreference', 'item', '')
	end

	parentcontrol.window.close()
end
